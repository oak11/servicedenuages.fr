<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Service de nuages, ">

        <link rel="alternate"  href="http://www.servicedenuages.fr/feeds/all.atom.xml" type="application/atom+xml" title="Service de nuages Full Atom Feed"/>

        <title>Signing collection to ensure data integrity // Service de nuages // </title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://www.servicedenuages.fr/theme/css/pure.css">
    <link rel="stylesheet" href="http://www.servicedenuages.fr/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
<div class="pure-g-r" id="layout">
    <div class="sidebar sidebar-article pure-u">
        <header class="header-article">
            <hgroup>
                <h5>PubliÃ©</h5>
                <p title="~687 mots">~3mn de lecture ðŸ•‘</p>
                <p>Wed 26 August 2015</p>
                <a href="/">&larr;Liste des articles</a>
            </hgroup>
        </header>
    </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Signing collection to ensure data integrity</h1>
                </header>
            </section>
                        <p><a href="http://www.servicedenuages.fr/en/../donnees-et-signatures">Lire la version franÃ§aise</a></p>
            <div class="note">
<p class="first admonition-title">Note</p>
<p class="last">Translated from the French by <a class="reference external" href="https://twitter.com/Natim">RÃ©my Hubscher</a>.</p>
</div>
<p>Within the scope of the <a class="reference external" href="https://wiki.mozilla.org/Firefox/Go_Faster">Go Faster</a>
project, we want to distribute Firefox updates more often than
just with major updates (which happens once every six weeks).</p>
<p>There are multiple kinds of data that we will need to update on the client;
for example, we would like to <a class="reference external" href="https://blog.mozilla.org/security/2015/03/03/revoking-intermediate-certificates-introducing-onecrl/">update the SSL Control Revocation List (named
OneCRL)</a>.</p>
<p>In that specific case, it is obviously very important to make sure that all the
retrieved data are coming from Mozilla and that no records are missing. We can
then be absolutely confident that nobody has attempted to invalidate a valid
certificate to the list (or remove one that has been revoked).</p>
<p>A cryptographic signature can give us the guarantee that all the records where
fetched but it is still possible to prevent users from completely accessing the
service (the <em>Great Firewall of China</em>, for example).</p>
<p>This mechanism works in our specific use-case of the OneCRL update project, but
it can also be useful to any future project that needs to make sure that all
records on a collection have been correctly synced. We will probably need to
re-use it to update other parts of Firefox (or Fennec), but you may also want
to use it for your projects.</p>
<p>We plan to use <a class="reference external" href="https://kinto.readthedocs.org">Kinto</a> in order to distribute
the data (or meta-data) associated with the files that need to be updated. It's
a good fit because it can be cached easily behind a CDN.</p>
<p>That said, we don't want our users to trust either the CDN or the Kinto server
itself without checking. Somebody can attack the CDN or the Kinto server and
may add or remove records and update the CRL. If you think about it is a
horrible scenario.</p>
<p>Consider the following work-flow:</p>
<ul class="simple">
<li>The person responsible for updating the CRL, <em>the updater</em>, has got a
private key (or even better <a class="reference external" href="https://en.wikipedia.org/wiki/Hardware_Security_Module">an HSM</a>) which
will enable them to sign a hash of the collection records.</li>
<li>The corresponding public key ships with the client (Firefox or Fennec).</li>
<li><em>Hashing</em> and <em>signature</em> generation are done on client side to prevent certain
attacks vectors (if somebody can access the Kinto server, for example).</li>
</ul>
<p>The <em>hashing</em> is a one-way operation that guarantees the same result given the
same input.</p>
<div class="section" id="first-data-issuance-on-kinto">
<h2>First data issuance on Kinto</h2>
<p>All the data are fetched from a <em>secure</em> source and converted into a JSON
collection. Each record is assigned a unique ID generated on client side.</p>
<p>For instance, we could have the following record:</p>
<div class="highlight"><pre><span class="p">{</span><span class="s2">"id"</span><span class="o">:</span> <span class="s2">"b7dded96-8df0-8af8-449a-8bc47f71b4c4"</span><span class="p">,</span>
 <span class="s2">"fingerprint"</span><span class="o">:</span> <span class="s2">"11:D5:D2:0A:9A:F8:D9:FC:23:6E:5C:5C:30:EC:AF:68:F5:68:FB:A3"</span><span class="p">}</span>
</pre></div>
<p>Then the collection <em>hash</em> is computed, signed, and then sent to the Kinto
server. (See below for details.)</p>
<p>The signature process is deported to a specific service in a sandbox
that ensures the certificate security which is crucial in the process.</p>
</div>
<div class="section" id="how-to-validate-data-integrity">
<h2>How to validate data integrity?</h2>
<p>First, we need to fetch the collection records as well as the hash and
the signature.</p>
<p>Then, we can validate that the hash signature is valid to make sure it
has been generated by a trusted source.</p>
<p>Finally we can serialise our local collection and compute its hash to
make sure it matches the signed one.</p>
</div>
<div class="section" id="update-the-collection-data">
<h2>Update the collection data</h2>
<p>When you need to <a class="reference external" href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">create, read, update or delete</a>
records in the collection, the client needs to make sure that the local
collection records match those of the remote server, and that they are valid.</p>
<p>Once we are confident that the collection update is valid, the client
can compute the new collection hash and sign it.</p>
</div>
<div class="section" id="how-to-compute-the-collection-hash">
<h2>How to compute the collection hash?</h2>
<p>To compute the collection <em>hash</em> you need a reproducible algorithm.</p>
<p>For instance one could be:</p>
<ol class="arabic simple">
<li>Sort records by their ids.</li>
<li>Serialise fields giving the value of each keys sorted by key.</li>
<li>Compute the <em>hash</em> of the records list serialization.</li>
</ol>
<p>We do not yet know the exact algorithm that we will be using.</p>
<p>An interesting candidate could be the <a class="reference external" href="https://tools.ietf.org/html/draft-ietf-jose-json-web-signature-41">JSON Web Signature</a>
standard. Meanwhile, a naive Python implementation could look like
this:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
   <span class="p">{</span><span class="s">"id"</span><span class="p">:</span> <span class="s">"b7dded96-8df0-8af8-449a-8bc47f71b4c4"</span><span class="p">,</span>
    <span class="s">"fingerprint"</span><span class="p">:</span> <span class="s">"11:D5:D2:0A:9A:F8:D9:FC:23:6E:5C:5C:30:EC:AF:68:F5:68:FB:A3"</span><span class="p">},</span>
   <span class="p">{</span><span class="s">"id"</span><span class="p">:</span> <span class="s">"dded96b7-8f0d-8f8a-49a4-7f771b4c4bc4"</span><span class="p">,</span>
    <span class="s">"fingerprint"</span><span class="p">:</span> <span class="s">"33:6E:5C:5C:30:EC:AF:68:F5:68:FB:A3:11:D5:D2:0A:9A:F8:D9:FC"</span><span class="p">}]</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
<span class="n">collection_hash</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</pre></div>
<p>Here is a little sketch to summarise:</p>
<img alt="Summary schema of the collection signing flow." class="align-center" src="http://www.servicedenuages.fr/en/../images/kinto-signing.jpg" style="width: 600px; height: auto; max-width: 100%;"/>
</div>

            <div class="hr"></div>
            <a href="#" class="go-top">Revenir au dÃ©but</a>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "servicedenuages"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div><footer class="footer">
    <p>&copy; Service de nuages &ndash;
        DÃ©veloppÃ© avec <a href="https://github.com/PurePelicanTheme/pure">Pure Theme</a>
        et <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
</div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>
<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.notmyidea.org/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 1]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//piwik.notmyidea.org/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->
  <script src="http://www.servicedenuages.fr/theme/js/instantclick.min.js" data-no-instant></script>
  <script data-no-instant>InstantClick.init();</script>
</body>
</html>